<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>weniv world</title>

    <!-- 환경파일 -->
    <script src="./assets/js/env.js" defer></script>

    <!-- JavaScript -->
    <script src="./assets/js/editor.js" defer></script>
    <script src="./assets/js/parser.js" defer></script>
    <script src="./assets/js/event.js" defer></script>

    <!-- PyScript -->
    <!-- TODO: 로컬로 바꿔야 합니다. -->
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <py-config>
        terminal = false
        # packages = ["numpy", "nest_asyncio"]

        [[fetch]]
        from = "./assets/py/"
        files = ["built_in_functions.py", "character.py", "map.py", "wall.py", "item.py", "coordinate.py", "modules.py", "error.py"]
    </py-config>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div id='app'></div>
    <p id="pointer"></p>
    <textarea id='output'></textarea>
    <button class='downloadNotebookBtn'>Download Notebook</button>
    <!-- TODO: 업로드 기능 구현 -->
    <button class='uploadNotebookBtn'>Upload Notebook</button>
    <div class="button-container">
        <input type="range" min="1" max="100" value="10" class="slider" id="speed-range">
        <p>Speed: <span id="speed-text"></span></p>
        <hr>
        <input type="range" min="3" max="10" value="5" class="slider" id="map-range-x">
        <p>Map_x: <span id="map-text-x"></span></p>
        <hr>
        <input type="range" min="3" max="10" value="5" class="slider" id="map-range-y">
        <p>Map_y: <span id="map-text-y"></span></p>
        <button id="init">초기화(월드, 캐릭터)</button>
        <button id="init_character">캐릭터 초기화</button>
        <button id="btn-list-function">함수 리스트</button>
        <button id="btn-list-variable">변수 리스트</button>
        <button id="btn-download-worlddata">다운로드 월드 데이터</button>
        <button id="btn-upload-worlddata">업로드 월드 데이터</button>
    </div>
    <section class="function-list hidden">
        <h3>함수 리스트</h3>
        <ul>
            <li>print()</li>
            <li>say()</li>
            <li>directions()</li>
            <li>show_item()</li>
            <li>set_item()</li>
            <li>move()</li>
            <li>turn_left()</li>
            <li>pick()</li>
            <li>put()</li>
            <li>repeat()</li>
            <li>(from modules import turn_right) turn_right()</li>
            <li>(from modules import turn_around) turn_around()</li>
            <li>(from modules import move_to_wall) move_to_wall()</li>
            <li>(from modules import turn_left_until_clear) turn_left_until_clear()</li>
            <li>(from modules import jump) jump()</li>
        </ul>
    </section>
    <section class="variable-list hidden">
        <h3>변수 리스트</h3>
        <ul>
            <li>character_data</li>
            <li>map_data</li>
            <li>item_data</li>
            <li>running_speed</li>
        </ul>
    </section>
    <section class="contents">
            <nav class="question-nav">
                <ol>
                    <li><a href="#" id="t1" class="btn-que">T1. 자격 증명</a></li>
                    <li><a href="#" id="t2" class="btn-que">T2. 암호문</a></li>
                </ol>
            </nav>
    </section>
    
    <!-- TODO: 배포 직전에는 style="display:none;"를 풀어야 합니다. -->
    <section class="description" style="display:none;"></section>
    <py-repl id="my-repl" auto-generate="true">
        # sample 코드입니다. shift + enter를 눌러 실행해보세요.
        # character_data, map_data, item_data는 기본 제공 데이터입니다.
        # from modules import turn_right와 같이 모듈을 불러와 사용할 수 있습니다.
        set_item(2, 2, 'fish')
        move()
        move()
        turn_left()
        turn_left()
        turn_left()
        repeat(2, move)
        # pick()
    </py-repl>
    <py-script>
        from map import Map
        from wall import Wall
        from character import Character
        from coordinate import character_data, map_data, wall_data, item_data, running_speed
        from built_in_functions import print, say, directions, show_item, set_item, move, turn_left, pick, put, repeat, attack
        from pyscript import when
        from js import alert, setTimeout
        from pyodide.ffi import create_once_callable
        import json
        import math

        # speed slide bar
        slider = js.document.getElementById("speed-range")
        slider_output = js.document.getElementById("speed-text")
        slider_output.innerHTML = slider.value
        running_speed = int(slider.value)/10


        def change_speed(e):
            global running_speed
            slider_output.innerHTML = slider.value
            running_speed = int(slider.value)/10
            if licat:
                licat.set_speed(running_speed)
            else:
                # 추후 다른 캐릭터 추가 시 구현
                pass

        slider.oninput = change_speed

        # map slide bar
        map_slider_x = js.document.getElementById("map-range-x")
        map_slider_y = js.document.getElementById("map-range-y")
        map_slider_output_x = js.document.getElementById("map-text-x")
        map_slider_output_y = js.document.getElementById("map-text-y")
        map_slider_output_x.innerHTML = map_slider_x.value
        map_slider_output_y.innerHTML = map_slider_y.value
        map_data['height'] = int(map_slider_x.value)
        map_data['width'] = int(map_slider_y.value)

        
        def change_map(e):
            map_data['height'] = int(map_slider_x.value)
            map_data['width'] = int(map_slider_y.value)
            map_slider_output_x.innerHTML = map_slider_x.value
            map_slider_output_y.innerHTML = map_slider_y.value
            map_exist = js.document.querySelector('.map-container')
            # TODO: map object는 map_data에서 관리해야할 것으로 보임
            if map_exist:
                js.document.querySelector('.map-container').remove()
                map = Map(map_data['height'], map_data['width'])
                draw_map = map.drawMap()
                draw_map.appendChild(draw_character)
                app = Element("app").element
                app.appendChild(draw_map)
            
            # 새로운 벽 데이터를 이용하여 벽 초기화
            wall.resetWall();
            wall_data={'wall': [], 'door': []}
            draw_map.appendChild(wall.container)
            
        
        map_slider_x.oninput = change_map
        map_slider_y.oninput = change_map

        # character 생성
        licat = Character(x=0, y=0, name='licat', width=32, height=40)
        character_data[0]['character_obj'] = licat
        draw_character = licat.draw()
        
        # map 생성
        map = Map(map_data['height'], map_data['width'])
        draw_map = map.drawMap()
        draw_map.appendChild(draw_character)

        #벽 생성
        wall = Wall(wall_data)
        wall.drawWall();
        draw_map.appendChild(wall.container)


        # 생성된 요소 app추가
        app = Element("app").element
        app.appendChild(draw_map)

        @when("click", selector="#init")
        def init(evt):
            js.console.log('월드 초기화')
            map_data['height'] = 5
            map_data['width'] = 5
            map_slider_output_x.innerHTML = 5
            map_slider_output_y.innerHTML = 5
            map_exist = js.document.querySelector('.map-container')
            # TODO: map object는 map_data에서 관리해야할 것으로 보임
            if map_exist:
                js.document.querySelector('.map-container').remove()
                map = Map(map_data['height'], map_data['width'])
                draw_map = map.drawMap()
                draw_map.appendChild(draw_character)
                app = Element("app").element
                app.appendChild(draw_map)

            # 새로운 벽 데이터를 이용하여 벽 초기화
            wall.resetWall();
            wall_data={'wall': [], 'door': []}
            draw_map.appendChild(wall.container)

            init_character()

        @when("click", selector="#init_character")
        def init_character(evt=None):
            js.console.log('캐릭터 초기화')
            js.document.querySelector('.character').remove()
            character_data[0] = {
                'character': 'licat',
                'character_obj': None,
                'x': 0,
                'y': 0,
                'directions': 0, # 0(동, 오른쪽), 1(북), 2(서, 왼쪽), 3(남)
                'items': {}
            }
            licat = Character(x=0, y=0, name='licat', width=32, height=40)
            for line in js.document.querySelectorAll('.line'):
                line.remove()
            character_data[0]['character_obj'] = licat
            draw_character = licat.draw()
            js.document.querySelector('.map-container').appendChild(draw_character)

        @when("click", selector="#btn-list-function")
        def list_function(evt=None):
            '''
            메인화면에서 함수 목록 보는 함수
            '''
            js.console.log('함수 목록')
            js.document.querySelector('.function-list').classList.toggle('hidden')

        @when("click", selector="#btn-list-variable")
        def list_variable(evt=None):
            '''
            메인화면에서 변수 목록 보는 함수
            '''
            js.console.log('변수 목록')
            js.document.querySelector('.variable-list').classList.toggle('hidden')

        @when("click", selector=".character")
        def show_character_info(evt=None):
            '''
            캐릭터를 클릭하면 캐릭터 정보(character_data)를 볼 수 있는 함수 
            '''
            # evt를 통해 x좌표, y좌표를 얻어냄
            # js.console.log(evt)
            x = evt.x
            y = evt.y
            # x좌표, y좌표에 말풍선 생성
            bubble = js.document.createElement('div')
            bubble.setAttribute('class', 'character-info-bubble')
            bubble.style.position = 'absolute'
            bubble.style.left = f'{x+10}px'
            bubble.style.top = f'{y+10}px'
            bubble.style.border = '1px solid black'
            bubble.style.borderRadius = '10px'
            bubble.style.borderTopLeftRadius = '0px'
            bubble.style.padding = '10px'
            bubble.style.backgroundColor = 'white'
            bubble.style.zIndex = '100'
            
            # 말풍선에 캐릭터 정보 추가
            bubble.innerHTML = f'''
                <div class="bubble-content">
                    <div class="bubble-title">캐릭터 정보</div>
                    <div class="bubble-body">
                        <div class="bubble-body-item">
                            <div class="bubble-body-item-title">이름</div>
                            <div class="bubble-body-item-content">{character_data[0]['character']}</div>
                        </div>
                        <div class="bubble-body-item">
                            <div class="bubble-body-item-title">x좌표</div>
                            <div class="bubble-body-item-content">{character_data[0]['x']}</div>
                        </div>
                        <div class="bubble-body-item">
                            <div class="bubble-body-item-title">y좌표</div>
                            <div class="bubble-body-item-content">{character_data[0]['y']}</div>
                        </div>
                        <div class="bubble-body-item">
                            <div class="bubble-body-item-title">방향</div>
                            <div class="bubble-body-item-content">{character_data[0]['directions']}</div>
                        </div>
                        <div class="bubble-body-item">
                            <div class="bubble-body-item-title">아이템</div>
                            <div class="bubble-body-item-content">{character_data[0]['items']}</div>
                        </div>
                    </div>
                </div>
            '''
            # 말풍선을 app에 추가
            app = js.document.querySelector('#app')
            app.appendChild(bubble)
            # 5초후 제거
            setTimeout(
                create_once_callable(
                    lambda: (
                        app.removeChild(bubble)
                    )
                ),
                5000
            )

        @when("click", selector="#btn-download-worlddata")
        def download_worlddata(evt=None):
            '''
            메인화면에서 월드데이터 다운로드
            '''
            js.console.log('월드데이터 다운로드')

            # 월드데이터 다운로드
            character_info = character_data.copy()
            character_info[0]['character_obj'] = None
            worlddata = {
                "character_data": character_info,
                "item_data": item_data,
                "map_data": map_data,
                "wall_data": wall_data
            }
            
            json_data = json.dumps(worlddata)
            file = js.File.new([json_data], "unused_file_name.txt", {type: "text/plain"})
            url = js.URL.createObjectURL(file)
            hidden_link = js.document.createElement("a")
            hidden_link.setAttribute("download", "my_other_file_name.txt")
            hidden_link.setAttribute("href", url)
            hidden_link.click()

        @when("click", selector="#btn-upload-worlddata")
        def upload_worlddata(evt=None):
            '''
            메인화면에서 월드데이터 업로드
            '''
            js.console.log('월드데이터 업로드')
        

        @when("click", selector=".wall-container")
        def add_wall(evt):
            '''
            맵에 벽 추가
            '''
            if(evt.target == evt.currentTarget):
                x = conver_position(evt.offsetY)
                y = conver_position(evt.offsetX)
                
            
                # x는 정수이고, y는 실수인 경우
                if(isinstance(x, int) and isinstance(y, float)) or (isinstance(x, float) and isinstance(y, int)):
                    wall_data['wall'].append((x, y))
                    wall.addWall('wall',(x, y))
            
        @when("mousemove", selector=".wall-container")
        def mouse_on(evt):
            '''
            맵이 벽을 추가할 수 있는 상태인지 확인하여 마우스 상태 변경
            '''
            if(evt.target == evt.currentTarget):
                wall_container = js.document.querySelector('.wall-container')
                
                x = conver_position(evt.offsetY)
                y = conver_position(evt.offsetX)
                
                if(isinstance(x, int) and isinstance(y, float)) or (isinstance(x, float) and isinstance(y, int)):
                    wall_container.style.cursor="pointer";
                else:
                    wall_container.style.cursor="auto";
        
        # offset 값을 입력했을 때, 좌표계 값으로 변환
        # 102는 한 변의 크기 + border*2 
        def conver_position(x):
            n = int(x/102)
            if n*102+1 < x < (n+1)*102-1:
                return n
            else: 
                return _get_integer(x/102)-0.5
        
        # 가장 가까운 정수 반환
        def _get_integer(num):
            integer = int(num + 0.5) if num >= 0 else int(num - 0.5)
            return integer
        
    </py-script>
    <script>
    const downloadBtn = document.querySelector('.downloadNotebookBtn')
    downloadBtn.addEventListener('click', () => {
        downloadNotebook()
    })
    function downloadNotebook() {
        const notebook = {
            "cells": [],
            "metadata": {
                "kernelspec": {
                    "display_name": "Python 3",
                    "language": "python",
                    "name": "python3"
                },
                "language_info": {
                    "codemirror_mode": {
                        "name": "ipython",
                        "version": 3
                    },
                    "file_extension": ".py",
                    "mimetype": "text/x-python",
                    "name": "python",
                    "nbconvert_exporter": "python",
                    "pygments_lexer": "ipython3",
                    "version": "3.7.9"
                }
            },
            "nbformat": 4,
            "nbformat_minor": 4
        };

        const cells = document.querySelectorAll('.py-repl-editor')

        for (let i = 0; i < cells.length; i++) {
            cells
            notebook.cells.push({
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": cells[i].childNodes[0].shadowRoot.querySelector('.cm-content').innerText
            });
        }

        const notebookJson = JSON.stringify(notebook, null, 2);
        const blob = new Blob([notebookJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.download = 'notebook.ipynb';
        a.href = url;
        a.click();
    }

    
    </script>
</body>
</html>