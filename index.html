<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>weniv world</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link rel="stylesheet" href="assets/css/main.css">
    <py-config>
        terminal = false
        [[fetch]]
        from = "./assets/py/"
        files = ["character.py", "coordinate.py"]
    </py-config>
</head>
<body>
    <div id='app'></div>
    <div id='output'></div>
    <py-repl id="my-repl" auto-generate="true">
        # sample 코드입니다. shift + enter를 눌러 실행해보세요.
        move()
        turn_left()
        turn_left()
        turn_left()
        repeat(2, move)
    </py-repl>
    <button class='downloadNotebookBtn'>Download Notebook</button>
    <py-script>
        import time
        from character import Character
        from coordinate import character_data

        def print(*args):
            '''
            html 문서 내 출력
            '''
            for arg in args:
                js.document.getElementById('output').innerHTML += str(arg) + '<br>'

        # 맵 크기는 전역에서 관리
        height = 5
        width = 5

        def drawMap(N, M):
            '''
            html문서 내 N X M 격자무늬 map을 그려주는 함수
            '''
            container = js.document.createElement('div')
            container.setAttribute('class', 'map-container')
            for i in range(0, N):
                flex = js.document.createElement('div')
                flex.setAttribute('class', 'map-flex')
                for j in range(0, M):
                    item = js.document.createElement('div')
                    item.setAttribute('class', 'map-item')
                    flex.appendChild(item)
                container.appendChild(flex)
            return container

        def move():
            if character_data[0]['direction'] == 0:
                if character_data[0]['x'] >= width-1:
                    js.alert('맵을 벗어납니다.')
                    return
                draw_map.querySelector('img').style.left = f'{character_data[0]["x"] * 100 + 125}px'
                character_data[0]["x"] += 1
            elif character_data[0]['direction'] == 1:
                if character_data[0]['y'] <= 0:
                    js.alert('맵을 벗어납니다.')
                    return
                draw_map.querySelector('img').style.top = f'{character_data[0]["y"] * 100 - 125}px'
                character_data[0]["y"] -= 1
            elif character_data[0]['direction'] == 2:
                if character_data[0]['x'] <= 0:
                    js.alert('맵을 벗어납니다.')
                    return
                draw_map.querySelector('img').style.left = f'{character_data[0]["x"] * 100 - 125}px'
                character_data[0]["x"] -= 1
            elif character_data[0]['direction'] == 3:
                if character_data[0]['y'] >= height-1:
                    js.alert('맵을 벗어납니다.')
                    return
                draw_map.querySelector('img').style.top = f'{character_data[0]["y"] * 100 + 125}px'
                character_data[0]["y"] += 1

        def turn_left():
            if character_data[0]['direction'] == 0:
                draw_map.querySelector('img').style.transform = 'rotate(-90deg)'
                character_data[0]['direction'] += 1
            elif character_data[0]['direction'] == 1:
                draw_map.querySelector('img').style.transform = 'rotate(-180deg)'
                character_data[0]['direction'] += 1
            elif character_data[0]['direction'] == 2:
                draw_map.querySelector('img').style.transform = 'rotate(-270deg)'
                character_data[0]['direction'] += 1
            elif character_data[0]['direction'] == 3:
                draw_map.querySelector('img').style.transform = 'rotate(0deg)'
                character_data[0]['direction'] = 0

        def repeat(count, f):
            for i in range(0, count):
                f()

        # character 생성
        licat = Character(0, 0, 'licat', width=60)
        draw_character = licat.draw()
        
        # map 생성
        draw_map = drawMap(height, width)
        draw_map.appendChild(draw_character)

        # 생성된 요소 app추가
        app = Element("app").element
        app.appendChild(draw_map)
    </py-script>
    <script>
    const downloadBtn = document.querySelector('.downloadNotebookBtn')
    downloadBtn.addEventListener('click', () => {
        downloadNotebook()
    })
    function downloadNotebook() {
        const notebook = {
            "cells": [],
            "metadata": {
                "kernelspec": {
                    "display_name": "Python 3",
                    "language": "python",
                    "name": "python3"
                },
                "language_info": {
                    "codemirror_mode": {
                        "name": "ipython",
                        "version": 3
                    },
                    "file_extension": ".py",
                    "mimetype": "text/x-python",
                    "name": "python",
                    "nbconvert_exporter": "python",
                    "pygments_lexer": "ipython3",
                    "version": "3.7.9"
                }
            },
            "nbformat": 4,
            "nbformat_minor": 4
        };

        const cells = document.querySelectorAll('.py-repl-editor')

        for (let i = 0; i < cells.length; i++) {
            cells
            notebook.cells.push({
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": cells[i].childNodes[0].shadowRoot.querySelector('.cm-content').innerText
            });
        }

        const notebookJson = JSON.stringify(notebook, null, 2);
        const blob = new Blob([notebookJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.download = 'notebook.ipynb';
        a.href = url;
        a.click();
    }
    </script>
</body>
</html>