<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>weniv world</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link rel="stylesheet" href="assets/css/main.css">
    <py-config>
        terminal = false
        # packages = ["numpy", "nest_asyncio"]

        [[fetch]]
        from = "./assets/py/"
        files = ["built_in_functions.py", "character.py", "map.py", "item.py", "coordinate.py", "modules.py", "error.py"]
    </py-config>
</head>
<body>
    <div id='app'></div>
    <textarea id='output'></textarea>
    <button class='downloadNotebookBtn'>Download Notebook</button>
    <div class="slidecontainer">
        <input type="range" min="1" max="100" value="10" class="slider" id="speed-range">
        <p>Speed: <span id="speed-text"></span></p>
        <hr>
        <input type="range" min="3" max="10" value="5" class="slider" id="map-range-x">
        <p>Map_x: <span id="map-text-x"></span></p>
        <hr>
        <input type="range" min="3" max="10" value="5" class="slider" id="map-range-y">
        <p>Map_y: <span id="map-text-y"></span></p>
    </div>
    <py-repl id="my-repl" auto-generate="true">
        # sample 코드입니다. shift + enter를 눌러 실행해보세요.
        # character_data, map_data, item_data는 기본 제공 데이터입니다.
        # from modules import turn_right와 같이 모듈을 불러와 사용할 수 있습니다.
        set_item(2, 2, 'fish')
        move()
        move()
        turn_left()
        turn_left()
        turn_left()
        repeat(2, move)
        # pick()
    </py-repl>
    <py-script>
        from map import Map
        from character import Character
        from coordinate import character_data, map_data, item_data, running_speed
        from built_in_functions import print, say, directions, show_item, set_item, move, turn_left, pick, put, repeat

        # speed slide bar
        slider = js.document.getElementById("speed-range")
        slider_output = js.document.getElementById("speed-text")
        slider_output.innerHTML = slider.value
        running_speed = int(slider.value)/10


        def change_speed(e):
            global running_speed
            slider_output.innerHTML = slider.value
            running_speed = int(slider.value)/10
            if licat:
                licat.set_speed(running_speed)
            else:
                # 추후 다른 캐릭터 추가 시 구현
                pass

        slider.oninput = change_speed

        # map slide bar
        map_slider_x = js.document.getElementById("map-range-x")
        map_slider_y = js.document.getElementById("map-range-y")
        map_slider_output_x = js.document.getElementById("map-text-x")
        map_slider_output_y = js.document.getElementById("map-text-y")
        map_slider_output_x.innerHTML = map_slider_x.value
        map_slider_output_y.innerHTML = map_slider_y.value
        map_data['height'] = int(map_slider_x.value)
        map_data['width'] = int(map_slider_y.value)

        
        def change_map(e):
            map_data['height'] = int(map_slider_x.value)
            map_data['width'] = int(map_slider_y.value)
            map_slider_output_x.innerHTML = map_slider_x.value
            map_slider_output_y.innerHTML = map_slider_y.value
            map_exist = js.document.querySelector('.map-container')
            # TODO: map object는 map_data에서 관리해야할 것으로 보임
            if map_exist:
                js.console.log('map exist')
                js.document.querySelector('.map-container').remove()
                map = Map(map_data['height'], map_data['width'])
                draw_map = map.drawMap()
                draw_map.appendChild(draw_character)
                app = Element("app").element
                app.appendChild(draw_map)
        
        map_slider_x.oninput = change_map
        map_slider_y.oninput = change_map

        # character 생성
        licat = Character(x=0, y=0, name='licat', width=32, height=40)
        character_data[0]['character_obj'] = licat
        draw_character = licat.draw()
        
        # map 생성
        map = Map(map_data['height'], map_data['width'])
        draw_map = map.drawMap()
        draw_map.appendChild(draw_character)

        # 생성된 요소 app추가
        app = Element("app").element
        app.appendChild(draw_map)
    </py-script>
    <script>
    const downloadBtn = document.querySelector('.downloadNotebookBtn')
    downloadBtn.addEventListener('click', () => {
        downloadNotebook()
    })
    function downloadNotebook() {
        const notebook = {
            "cells": [],
            "metadata": {
                "kernelspec": {
                    "display_name": "Python 3",
                    "language": "python",
                    "name": "python3"
                },
                "language_info": {
                    "codemirror_mode": {
                        "name": "ipython",
                        "version": 3
                    },
                    "file_extension": ".py",
                    "mimetype": "text/x-python",
                    "name": "python",
                    "nbconvert_exporter": "python",
                    "pygments_lexer": "ipython3",
                    "version": "3.7.9"
                }
            },
            "nbformat": 4,
            "nbformat_minor": 4
        };

        const cells = document.querySelectorAll('.py-repl-editor')

        for (let i = 0; i < cells.length; i++) {
            cells
            notebook.cells.push({
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": cells[i].childNodes[0].shadowRoot.querySelector('.cm-content').innerText
            });
        }

        const notebookJson = JSON.stringify(notebook, null, 2);
        const blob = new Blob([notebookJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.download = 'notebook.ipynb';
        a.href = url;
        a.click();
    }
    </script>
</body>
</html>